%function [U,D,H] = diag3D2(A,B,delta,jz)

%This script creates and diagonalizes the matrix H


%The following code was generated with ToMatlab (Google it)


H(:,:,1,1) = 1i*(a-b-2i*jz);
H(:,:,1,2) = A+conj(B);
H(:,:,1,3) = 1i*(a+b);
H(:,:,1,4) = -A+2i*d+conj(B);

H(:,:,2,1) = B+conj(A);
H(:,:,2,2) = -1i*(a-b+2i*jz);
H(:,:,2,3) = -B+conj(A)-2i*conj(d);
H(:,:,2,4) = 1i*(a+b);

H(:,:,3,1) = 1i*(a+b);
H(:,:,3,2) = A+2i*d-conj(B); 
H(:,:,3,3) = 1i*(a-b+2i*jz);
H(:,:,3,4) = -A-conj(B);   

H(:,:,4,1) = B-conj(A)-2i*conj(d);
H(:,:,4,2) = 1i*(a+b); 
H(:,:,4,3) = -B-conj(A);
H(:,:,4,4) = 1i*(-a+b+2i*jz);  


H  = H/8;


em = ((-1/8).*a.^2+(-1/8).*b.^2+(1/4).*jz.^2+(1/8).*A.*conj(A)+(1/8).* ...
  B.*conj(B)+(1/4).*d.*conj(d)+(-1/32).*((4.*a.^2+4.*b.^2+(-8).* ...
  jz.^2+(-4).*A.*conj(A)+(-4).*B.*conj(B)+(-8).*d.*conj(d)).^2+(-64) ...
  .*(a.^2.*b.^2+2.*a.*B.*d.*jz+(-2).*a.*b.*jz.^2+(-1).*A.*B.*jz.^2+ ...
  jz.^4+(-1).*A.*b.^2.*conj(A)+(-1).*B.*d.^2.*conj(A)+2.*b.*d.*jz.* ...
  conj(A)+(-1).*a.^2.*B.*conj(B)+A.*B.*conj(A).*conj(B)+(-1).* ...
  jz.^2.*conj(A).*conj(B)+2.*a.*b.*d.*conj(d)+(-2).*A.*b.*jz.*conj( ...
  d)+2.*d.*jz.^2.*conj(d)+(-2).*a.*jz.*conj(B).*conj(d)+d.^2.*conj( ...
  d).^2+(-1).*A.*conj(B).*conj(d).^2)).^(1/2)).^(1/2)/2;
  
ep = ((-1/8).*a.^2+ ...
  (-1/8).*b.^2+(1/4).*jz.^2+(1/8).*A.*conj(A)+(1/8).*B.*conj(B)+( ...
  1/4).*d.*conj(d)+(1/32).*((4.*a.^2+4.*b.^2+(-8).*jz.^2+(-4).*A.* ...
  conj(A)+(-4).*B.*conj(B)+(-8).*d.*conj(d)).^2+(-64).*(a.^2.*b.^2+ ...
  2.*a.*B.*d.*jz+(-2).*a.*b.*jz.^2+(-1).*A.*B.*jz.^2+jz.^4+(-1).*A.* ...
  b.^2.*conj(A)+(-1).*B.*d.^2.*conj(A)+2.*b.*d.*jz.*conj(A)+(-1).* ...
  a.^2.*B.*conj(B)+A.*B.*conj(A).*conj(B)+(-1).*jz.^2.*conj(A).* ...
  conj(B)+2.*a.*b.*d.*conj(d)+(-2).*A.*b.*jz.*conj(d)+2.*d.*jz.^2.* ...
  conj(d)+(-2).*a.*jz.*conj(B).*conj(d)+d.^2.*conj(d).^2+(-1).*A.* ...
  conj(B).*conj(d).^2)).^(1/2)).^(1/2)/2;


D(:,:,1,1) = em;
D(:,:,2,2) = ep;
D(:,:,3,3) = -em;
D(:,:,4,4) = -ep;

%The eigenvectors with positive eigenvalues em < ep

vm(:,:,1) = (1i*( ...
  -1)).*(B.*(a.^2+4.*em.^2+(1i*2).*a.*jz+(-1).*jz.^2)+conj(A) ...
  .*((-1).*b.^2+(-1).*A.*B+(1i*(-2)).*B.*d+(-4).*em.^2+(sqrt( ...
  -1)*2).*b.*jz+jz.^2+B.*conj(B))+2.*((-1).*b.*jz+a.*(1i.*b+ ...
  jz)+1i.*((-4).*em.^2+jz.^2)).*conj(d)+(A+(1i*2).*d+( ...
  -1).*conj(B)).*conj(d).^2).^(-1).*(a.^2.*b+(-1).*a.*b.^2+(1i ...
  *(-1)).*a.*B.*d+(1i*2).*a.^2.*em+(1i*2).*b.^2.*em+(-2) ...
  .*B.*d.*em+(-4).*a.*em.^2+4.*b.*em.^2+(1i*16).*em.^3+(sqrt( ...
  -1)*2).*a.*b.*jz+1i.*A.*B.*jz+(-1).*B.*d.*jz+(-4).*a.*em.* ...
  jz+4.*b.*em.*jz+(1i*8).*em.^2.*jz+(-1).*a.*jz.^2+b.*jz.^2+( ...
  1i*(-4)).*em.*jz.^2+(1i*(-2)).*jz.^3+conj(A).*((-1).* ...
  A.*(b+(1i*2).*em)+d.*((1i*(-1)).*b+2.*em+jz)+1i ...
  .*jz.*conj(B))+1i.*A.*b.*conj(d)+a.*d.*conj(d)+(-1).*b.*d.* ...
  conj(d)+(-2).*A.*em.*conj(d)+(1i*(-4)).*d.*em.*conj(d)+(-1) ...
  .*A.*jz.*conj(d)+(1i*(-2)).*d.*jz.*conj(d)+conj(B).*(B.*(a+( ...
  1i*(-2)).*em)+(1i.*a+2.*em+jz).*conj(d)));

vm(:,:,2) = (B.*(a.^2+ ...
  4.*em.^2+(1i*2).*a.*jz+(-1).*jz.^2)+conj(A).*((-1).*b.^2+( ...
  -1).*A.*B+(1i*(-2)).*B.*d+(-4).*em.^2+(1i*2).*b.*jz+ ...
  jz.^2+B.*conj(B))+2.*((-1).*b.*jz+a.*(1i.*b+jz)+1i.*(( ...
  -4).*em.^2+jz.^2)).*conj(d)+(A+(1i*2).*d+(-1).*conj(B)).* ...
  conj(d).^2).^(-1).*(B.*(a.^2+(2.*em+jz).^2)+conj(A).*(b.^2+(-1).* ...
  A.*B+4.*em.^2+4.*em.*jz+jz.^2+(-1).*B.*conj(B))+2.*(a+b).*(2.*em+ ...
  jz).*conj(d)+(A+conj(B)).*conj(d).^2);

vm(:,:,3) = 1i.*(B.*(a.^2+4.* ...
  em.^2+(1i*2).*a.*jz+(-1).*jz.^2)+conj(A).*((-1).*b.^2+(-1).* ...
  A.*B+(1i*(-2)).*B.*d+(-4).*em.^2+(1i*2).*b.*jz+jz.^2+ ...
  B.*conj(B))+2.*((-1).*b.*jz+a.*(1i.*b+jz)+1i.*((-4).* ...
  em.^2+jz.^2)).*conj(d)+(A+(1i*2).*d+(-1).*conj(B)).*conj(d) ...
  .^2).^(-1).*(a.^2.*b+a.*b.^2+1i.*a.*B.*d+(1i*2).* ...
  a.^2.*em+(1i*(-2)).*b.^2.*em+2.*B.*d.*em+4.*a.*em.^2+4.*b.* ...
  em.^2+(1i*(-1)).*A.*B.*jz+B.*d.*jz+(-1).*a.*jz.^2+(-1).*b.* ...
  jz.^2+conj(A).*((-1).*A.*(b+(1i*2).*em)+d.*((1i*(-1)) ...
  .*b+2.*em+jz)+1i.*jz.*conj(B))+(1i*(-1)).*A.*b.*conj( ...
  d)+a.*d.*conj(d)+b.*d.*conj(d)+2.*A.*em.*conj(d)+(-1).*A.*jz.* ...
  conj(d)+conj(B).*((-1).*B.*(a+(1i*(-2)).*em)+(1i.*a+ ...
  2.*em+(-1).*jz).*conj(d)));

vm(:,:,4) = 1;

normm = sqrt(1 + abs(vm(:,:,1)).^2 + abs(vm(:,:,2)).^2 + abs(vm(:,:,3)).^2);

vp(:,:,1) = (1i*(-1)).*(B.*(a.^2+4.*ep.^2+(1i*2) ...
  .*a.*jz+(-1).*jz.^2)+conj(A).*((-1).*b.^2+(-1).*A.*B+(1i*( ...
  -2)).*B.*d+(-4).*ep.^2+(1i*2).*b.*jz+jz.^2+B.*conj(B))+2.*(( ...
  -1).*b.*jz+a.*(1i.*b+jz)+1i.*((-4).*ep.^2+jz.^2)).* ...
  conj(d)+(A+(1i*2).*d+(-1).*conj(B)).*conj(d).^2).^(-1).*( ...
  a.^2.*b+(-1).*a.*b.^2+(1i*(-1)).*a.*B.*d+(1i*2).* ...
  a.^2.*ep+(1i*2).*b.^2.*ep+(-2).*B.*d.*ep+(-4).*a.*ep.^2+4.* ...
  b.*ep.^2+(1i*16).*ep.^3+(1i*2).*a.*b.*jz+1i.*A.* ...
  B.*jz+(-1).*B.*d.*jz+(-4).*a.*ep.*jz+4.*b.*ep.*jz+(1i*8).* ...
  ep.^2.*jz+(-1).*a.*jz.^2+b.*jz.^2+(1i*(-4)).*ep.*jz.^2+( ...
  1i*(-2)).*jz.^3+conj(A).*((-1).*A.*(b+(1i*2).*ep)+d.*( ...
  (1i*(-1)).*b+2.*ep+jz)+1i.*jz.*conj(B))+1i.*A.* ...
  b.*conj(d)+a.*d.*conj(d)+(-1).*b.*d.*conj(d)+(-2).*A.*ep.*conj(d)+ ...
  (1i*(-4)).*d.*ep.*conj(d)+(-1).*A.*jz.*conj(d)+(1i*( ...
  -2)).*d.*jz.*conj(d)+conj(B).*(B.*(a+(1i*(-2)).*ep)+(sqrt( ...
  -1).*a+2.*ep+jz).*conj(d)));

vp(:,:,2) = (B.*(a.^2+4.*ep.^2+(1i*2).*a.* ...
  jz+(-1).*jz.^2)+conj(A).*((-1).*b.^2+(-1).*A.*B+(1i*(-2)).* ...
  B.*d+(-4).*ep.^2+(1i*2).*b.*jz+jz.^2+B.*conj(B))+2.*((-1).* ...
  b.*jz+a.*(1i.*b+jz)+1i.*((-4).*ep.^2+jz.^2)).*conj(d)+ ...
  (A+(1i*2).*d+(-1).*conj(B)).*conj(d).^2).^(-1).*(B.*(a.^2+( ...
  2.*ep+jz).^2)+conj(A).*(b.^2+(-1).*A.*B+4.*ep.^2+4.*ep.*jz+jz.^2+( ...
  -1).*B.*conj(B))+2.*(a+b).*(2.*ep+jz).*conj(d)+(A+conj(B)).*conj( ...
  d).^2);

vp(:,:,3) = 1i.*(B.*(a.^2+4.*ep.^2+(1i*2).*a.*jz+(-1).* ...
  jz.^2)+conj(A).*((-1).*b.^2+(-1).*A.*B+(1i*(-2)).*B.*d+(-4) ...
  .*ep.^2+(1i*2).*b.*jz+jz.^2+B.*conj(B))+2.*((-1).*b.*jz+a.*( ...
  1i.*b+jz)+1i.*((-4).*ep.^2+jz.^2)).*conj(d)+(A+(sqrt( ...
  -1)*2).*d+(-1).*conj(B)).*conj(d).^2).^(-1).*(a.^2.*b+a.*b.^2+ ...
  1i.*a.*B.*d+(1i*2).*a.^2.*ep+(1i*(-2)).*b.^2.* ...
  ep+2.*B.*d.*ep+4.*a.*ep.^2+4.*b.*ep.^2+(1i*(-1)).*A.*B.*jz+ ...
  B.*d.*jz+(-1).*a.*jz.^2+(-1).*b.*jz.^2+conj(A).*((-1).*A.*(b+( ...
  1i*2).*ep)+d.*((1i*(-1)).*b+2.*ep+jz)+1i.*jz.* ...
  conj(B))+(1i*(-1)).*A.*b.*conj(d)+a.*d.*conj(d)+b.*d.*conj( ...
  d)+2.*A.*ep.*conj(d)+(-1).*A.*jz.*conj(d)+conj(B).*((-1).*B.*(a+( ...
  1i*(-2)).*ep)+(1i.*a+2.*ep+(-1).*jz).*conj(d)) );

vp(:,:,4) = 1;
  
normp = sqrt(1 + abs(vp(:,:,1)).^2 + abs(vp(:,:,2)).^2 + abs(vp(:,:,3)).^2);

%Now take k to -k
A=conj(A); B=conj(B); d = conj(d); a=conj(a); b=conj(b);

vm2(:,:,1) = (1i*( ...
  -1)).*(B.*(a.^2+4.*em.^2+(1i*2).*a.*jz+(-1).*jz.^2)+conj(A) ...
  .*((-1).*b.^2+(-1).*A.*B+(1i*(-2)).*B.*d+(-4).*em.^2+(sqrt( ...
  -1)*2).*b.*jz+jz.^2+B.*conj(B))+2.*((-1).*b.*jz+a.*(1i.*b+ ...
  jz)+1i.*((-4).*em.^2+jz.^2)).*conj(d)+(A+(1i*2).*d+( ...
  -1).*conj(B)).*conj(d).^2).^(-1).*(a.^2.*b+(-1).*a.*b.^2+(1i ...
  *(-1)).*a.*B.*d+(1i*2).*a.^2.*em+(1i*2).*b.^2.*em+(-2) ...
  .*B.*d.*em+(-4).*a.*em.^2+4.*b.*em.^2+(1i*16).*em.^3+(sqrt( ...
  -1)*2).*a.*b.*jz+1i.*A.*B.*jz+(-1).*B.*d.*jz+(-4).*a.*em.* ...
  jz+4.*b.*em.*jz+(1i*8).*em.^2.*jz+(-1).*a.*jz.^2+b.*jz.^2+( ...
  1i*(-4)).*em.*jz.^2+(1i*(-2)).*jz.^3+conj(A).*((-1).* ...
  A.*(b+(1i*2).*em)+d.*((1i*(-1)).*b+2.*em+jz)+1i ...
  .*jz.*conj(B))+1i.*A.*b.*conj(d)+a.*d.*conj(d)+(-1).*b.*d.* ...
  conj(d)+(-2).*A.*em.*conj(d)+(1i*(-4)).*d.*em.*conj(d)+(-1) ...
  .*A.*jz.*conj(d)+(1i*(-2)).*d.*jz.*conj(d)+conj(B).*(B.*(a+( ...
  1i*(-2)).*em)+(1i.*a+2.*em+jz).*conj(d)));

vm2(:,:,2) = (B.*(a.^2+ ...
  4.*em.^2+(1i*2).*a.*jz+(-1).*jz.^2)+conj(A).*((-1).*b.^2+( ...
  -1).*A.*B+(1i*(-2)).*B.*d+(-4).*em.^2+(1i*2).*b.*jz+ ...
  jz.^2+B.*conj(B))+2.*((-1).*b.*jz+a.*(1i.*b+jz)+1i.*(( ...
  -4).*em.^2+jz.^2)).*conj(d)+(A+(1i*2).*d+(-1).*conj(B)).* ...
  conj(d).^2).^(-1).*(B.*(a.^2+(2.*em+jz).^2)+conj(A).*(b.^2+(-1).* ...
  A.*B+4.*em.^2+4.*em.*jz+jz.^2+(-1).*B.*conj(B))+2.*(a+b).*(2.*em+ ...
  jz).*conj(d)+(A+conj(B)).*conj(d).^2);

vm2(:,:,3) = 1i.*(B.*(a.^2+4.* ...
  em.^2+(1i*2).*a.*jz+(-1).*jz.^2)+conj(A).*((-1).*b.^2+(-1).* ...
  A.*B+(1i*(-2)).*B.*d+(-4).*em.^2+(1i*2).*b.*jz+jz.^2+ ...
  B.*conj(B))+2.*((-1).*b.*jz+a.*(1i.*b+jz)+1i.*((-4).* ...
  em.^2+jz.^2)).*conj(d)+(A+(1i*2).*d+(-1).*conj(B)).*conj(d) ...
  .^2).^(-1).*(a.^2.*b+a.*b.^2+1i.*a.*B.*d+(1i*2).* ...
  a.^2.*em+(1i*(-2)).*b.^2.*em+2.*B.*d.*em+4.*a.*em.^2+4.*b.* ...
  em.^2+(1i*(-1)).*A.*B.*jz+B.*d.*jz+(-1).*a.*jz.^2+(-1).*b.* ...
  jz.^2+conj(A).*((-1).*A.*(b+(1i*2).*em)+d.*((1i*(-1)) ...
  .*b+2.*em+jz)+1i.*jz.*conj(B))+(1i*(-1)).*A.*b.*conj( ...
  d)+a.*d.*conj(d)+b.*d.*conj(d)+2.*A.*em.*conj(d)+(-1).*A.*jz.* ...
  conj(d)+conj(B).*((-1).*B.*(a+(1i*(-2)).*em)+(1i.*a+ ...
  2.*em+(-1).*jz).*conj(d)));

vm2(:,:,4) = 1;

normm2 = sqrt(1 + abs(vm2(:,:,1)).^2 + abs(vm2(:,:,2)).^2 + abs(vm2(:,:,3)).^2);

vp2(:,:,1) = (1i*(-1)).*(B.*(a.^2+4.*ep.^2+(1i*2) ...
  .*a.*jz+(-1).*jz.^2)+conj(A).*((-1).*b.^2+(-1).*A.*B+(1i*( ...
  -2)).*B.*d+(-4).*ep.^2+(1i*2).*b.*jz+jz.^2+B.*conj(B))+2.*(( ...
  -1).*b.*jz+a.*(1i.*b+jz)+1i.*((-4).*ep.^2+jz.^2)).* ...
  conj(d)+(A+(1i*2).*d+(-1).*conj(B)).*conj(d).^2).^(-1).*( ...
  a.^2.*b+(-1).*a.*b.^2+(1i*(-1)).*a.*B.*d+(1i*2).* ...
  a.^2.*ep+(1i*2).*b.^2.*ep+(-2).*B.*d.*ep+(-4).*a.*ep.^2+4.* ...
  b.*ep.^2+(1i*16).*ep.^3+(1i*2).*a.*b.*jz+1i.*A.* ...
  B.*jz+(-1).*B.*d.*jz+(-4).*a.*ep.*jz+4.*b.*ep.*jz+(1i*8).* ...
  ep.^2.*jz+(-1).*a.*jz.^2+b.*jz.^2+(1i*(-4)).*ep.*jz.^2+( ...
  1i*(-2)).*jz.^3+conj(A).*((-1).*A.*(b+(1i*2).*ep)+d.*( ...
  (1i*(-1)).*b+2.*ep+jz)+1i.*jz.*conj(B))+1i.*A.* ...
  b.*conj(d)+a.*d.*conj(d)+(-1).*b.*d.*conj(d)+(-2).*A.*ep.*conj(d)+ ...
  (1i*(-4)).*d.*ep.*conj(d)+(-1).*A.*jz.*conj(d)+(1i*( ...
  -2)).*d.*jz.*conj(d)+conj(B).*(B.*(a+(1i*(-2)).*ep)+(sqrt( ...
  -1).*a+2.*ep+jz).*conj(d)));

vp2(:,:,2) = (B.*(a.^2+4.*ep.^2+(1i*2).*a.* ...
  jz+(-1).*jz.^2)+conj(A).*((-1).*b.^2+(-1).*A.*B+(1i*(-2)).* ...
  B.*d+(-4).*ep.^2+(1i*2).*b.*jz+jz.^2+B.*conj(B))+2.*((-1).* ...
  b.*jz+a.*(1i.*b+jz)+1i.*((-4).*ep.^2+jz.^2)).*conj(d)+ ...
  (A+(1i*2).*d+(-1).*conj(B)).*conj(d).^2).^(-1).*(B.*(a.^2+( ...
  2.*ep+jz).^2)+conj(A).*(b.^2+(-1).*A.*B+4.*ep.^2+4.*ep.*jz+jz.^2+( ...
  -1).*B.*conj(B))+2.*(a+b).*(2.*ep+jz).*conj(d)+(A+conj(B)).*conj( ...
  d).^2);

vp2(:,:,3) = 1i.*(B.*(a.^2+4.*ep.^2+(1i*2).*a.*jz+(-1).* ...
  jz.^2)+conj(A).*((-1).*b.^2+(-1).*A.*B+(1i*(-2)).*B.*d+(-4) ...
  .*ep.^2+(1i*2).*b.*jz+jz.^2+B.*conj(B))+2.*((-1).*b.*jz+a.*( ...
  1i.*b+jz)+1i.*((-4).*ep.^2+jz.^2)).*conj(d)+(A+(sqrt( ...
  -1)*2).*d+(-1).*conj(B)).*conj(d).^2).^(-1).*(a.^2.*b+a.*b.^2+ ...
  1i.*a.*B.*d+(1i*2).*a.^2.*ep+(1i*(-2)).*b.^2.* ...
  ep+2.*B.*d.*ep+4.*a.*ep.^2+4.*b.*ep.^2+(1i*(-1)).*A.*B.*jz+ ...
  B.*d.*jz+(-1).*a.*jz.^2+(-1).*b.*jz.^2+conj(A).*((-1).*A.*(b+( ...
  1i*2).*ep)+d.*((1i*(-1)).*b+2.*ep+jz)+1i.*jz.* ...
  conj(B))+(1i*(-1)).*A.*b.*conj(d)+a.*d.*conj(d)+b.*d.*conj( ...
  d)+2.*A.*ep.*conj(d)+(-1).*A.*jz.*conj(d)+conj(B).*((-1).*B.*(a+( ...
  1i*(-2)).*ep)+(1i.*a+2.*ep+(-1).*jz).*conj(d)) );

vp2(:,:,4) = 1;

normp2 = sqrt(1 + abs(vp2(:,:,1)).^2 + abs(vp2(:,:,2)).^2 + abs(vp2(:,:,3)).^2);
  
vm2 = mult4(gamma,conj(vm2));
vp2 = mult4(gamma,conj(vp2));

for m=1:4
    vm(:,:,m) = vm(:,:,m)./normm;
    vp(:,:,m) = vp(:,:,m)./normp;
    vm2(:,:,m)=vm2(:,:,m)./normm2;
    vp2(:,:,m)=vp2(:,:,m)./normp2;
end

U(:,:,:,1) = vm;
U(:,:,:,2) = vp;
U(:,:,:,3) = vm2;
U(:,:,:,4) = vp2;

%U2 = mult4( gamma , mult4(conj(U),gamma) );


